<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Threat Shield ‚Äî Network Malware Simulator (Educational)</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;700&display=swap');
:root {
  --bg: #10192b;
  --card: #17213c;
  --accent: #00fc99;
  --muted: rgba(0,252,153,0.17);
  --safe: #22c55e;
  --sus: #f2c94c;
  --infected: #ff3b30;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  height: 100%;
  font-family: 'Fira Mono', monospace;
  background: linear-gradient(180deg,#081325,#16223c);
  color: #c0fff2;
  font-size: 16px;
}
button {
  cursor: pointer;
  background: var(--accent);
  color: #142325;
  border: none;
  border-radius: 8px;
  padding: 9px 18px;
  font-weight: bold;
  font-size: 1rem;
  transition: background 0.19s, color 0.19s;
  margin: 2px 0;
}
button:hover, .btn-primary:hover { background: #22c55e; color: #17213c; }
.btn-secondary, .btn-ghost {
  background: transparent;
  color: #00fc99;
  border: 1.5px solid var(--muted);
}
.btn-secondary:hover { background: #142325; color: #00fc99; }
.btn-ghost { border-style: dashed; }
.app {
  max-width: 1100px;
  margin: 24px auto;
  padding: 18px;
  display: grid;
  grid-template-columns: 1fr 410px;
  gap: 18px;
}
.header {
  grid-column: 1/-1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 13px;
  margin-bottom: 9px;
}
.brand {
  font-size: 1.8rem;
  color: var(--accent);
  text-shadow: 0 0 14px rgba(0,252,153,0.25);
  font-weight: 900;
}
.subtitle {
  color: #b3fee1;
  font-size: 1rem;
  font-style: italic;
}
.panel {
  background: linear-gradient(180deg, #17213c 58%, #10192b 100%);
  border-radius: 11px;
  padding: 14px;
  border: 2px solid var(--muted);
  box-shadow: 0 9px 32px rgba(0,252,153, 0.03);
}
.network-wrap { position: relative; border-radius: 9px; padding: 7px; background: #171f30; }
.canvas-holder { width: 100%; height: 560px; max-height: 70vh; display: flex; align-items: center; justify-content: center; position: relative; }
#networkCanvas { width: 100%; height: 100%; display: block; border-radius: 9px; background: radial-gradient(circle at 10% 10%, rgba(0,252,153,0.07), transparent 6%), linear-gradient(180deg,#170f36,#10192b); }

.legend {
  display: flex; gap: 11px; align-items: center; margin-top: 13px; flex-wrap: wrap;
}
.legend .item { display: flex; align-items: center; gap: 7px; color: #c0fff2; font-size: 0.93rem;}
.legend .dot { width: 13px; height: 13px; border-radius: 50%; border: 1.2px solid #243957;}

.controls {
  background: linear-gradient(180deg, #161d2f 80%, #10192b 100%);
  padding: 14px; border-radius: 10px; border: 2px solid var(--muted);
}
.controls .row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px;}
.select, .range, .btn { width: 100%; }
select, input[type="range"] {
  background: #101929;
  border-radius: 7px;
  padding: 8px;
  border: 1.2px solid #00fc99;
  color: #00fc99;
  font-family: inherit;
  font-size: 1rem;
  margin-right: 4px;
}
select:focus, input[type="range"]:focus{ outline: 2px solid #00fc99; }
.small { font-size: 0.95rem; color: #98ecd4; }
.terminal {
  background: #121b23;
  border-radius: 9px;
  padding: 13px;
  font-family: 'Fira Mono', monospace;
  font-size: 0.90rem;
  color: #00fc99;
  max-height: 340px; overflow: auto;
  border: 2px solid #00fc9940;
}
.term-line { margin-bottom: 8px; line-height: 1.26; }
.term-time { color: #ffd600; margin-right: 7px; }
.summary {
  margin-top: 10px;
  background: linear-gradient(180deg, #17213c 80%, transparent);
  padding: 11px;
  border-radius: 9px;
  border: 2px solid #00fc9940;
}
.summary .stat { display: flex; justify-content: space-between; padding: 7px 0; color: #00fc99; font-weight: 700;}
.footer { grid-column:1/-1; text-align:center; color: #b3fee1; margin-top:10px; }
@media (max-width:1080px){ .app{grid-template-columns:1fr 370px} .canvas-holder{height:510px;} }
@media (max-width:900px){.app{grid-template-columns:1fr; padding:12px;} .canvas-holder{height:410px;}}
@media (max-width:600px){.canvas-holder{height:340px;} .brand{font-size:1.2rem;} }
</style>
</head>
<body>

<div class="app" role="main" aria-label="Threat Shield Network Simulator">
  <div class="header">
    <div>
      <div class="brand">üõ°Ô∏è Threat Shield</div>
      <div class="subtitle">Developed by Dwij Rajyaguru ‚Äî Educational network simulator</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="small">Mode: Demo (always safe ‚Äî visualization only)</div>
    </div>
  </div>

  <!-- LEFT: Network visualization -->
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:800;color:#00fc99">Network View</div>
      <div style="font-size:0.9rem;color:#98ecd4">Click a device to view details</div>
    </div>

    <div class="network-wrap">
      <div class="canvas-holder">
        <canvas id="networkCanvas" aria-label="Network canvas visualization"></canvas>
      </div>
    </div>

    <div class="legend" aria-hidden="false">
      <div class="item"><div class="dot" style="background:linear-gradient(90deg,var(--safe),#22c55e)"></div>Safe</div>
      <div class="item"><div class="dot" style="background:linear-gradient(90deg,var(--sus),#f2c94c)"></div>Suspected</div>
      <div class="item"><div class="dot" style="background:linear-gradient(90deg,var(--infected),#ff3b30)"></div>Infected</div>
      <div class="item"><div class="dot" style="background:linear-gradient(90deg,#00a5fa,#0082f6)"></div>Seed / Target</div>
    </div>
  </div>

  <!-- RIGHT: Controls + Terminal + Summary -->
  <div>
    <div class="controls" role="region" aria-label="Simulation controls">
      <div class="row" style="gap:10px">
        <label for="threatSelect" class="small" style="width:110px">Threat Type</label>
        <select id="threatSelect" class="select" aria-label="Select threat">
          <option value="worm">Worm ‚Äî fast spread</option>
          <option value="trojan">Trojan ‚Äî stealthy activation</option>
          <option value="virus">Virus ‚Äî spreads via sharing</option>
        </select>
      </div>

      <div class="row">
        <label class="small" style="width:110px">Network Size</label>
        <input id="sizeRange" class="range" type="range" min="6" max="32" value="14" aria-label="Network size"/>
        <div style="width:40px;text-align:right;font-weight:800;color:#c0fff2" id="sizeVal">14</div>
      </div>

      <div class="row">
        <label class="small" style="width:110px">Speed</label>
        <input id="speedRange" class="range" type="range" min="1" max="10" value="6" aria-label="Simulation speed"/>
        <div style="width:40px;text-align:right;font-weight:800;color:#c0fff2" id="speedVal">6</div>
      </div>

      <div class="row" style="margin-top:6px;gap:8px">
        <button class="btn-primary" id="startBtn">Start</button>
        <button class="btn-secondary" id="pauseBtn" disabled>Pause</button>
        <button class="btn-secondary" id="resumeBtn" disabled>Resume</button>
      </div>

      <div class="row" style="margin-top:8px;gap:8px">
        <button class="btn-ghost" id="seedBtn">Seed Random Device</button>
        <button class="btn-ghost" id="resetBtn">Reset Network</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn-primary" id="exportLog">Export Log</button>
        <button class="btn-secondary" id="downloadPNG">Download Screenshot</button>
      </div>

      <div style="margin-top:12px">
        <div class="small" style="margin-bottom:6px">Volume</div>
        <input type="range" id="volRange" min="0" max="1" step="0.01" value="0.6" aria-label="Volume control"/>
      </div>
      
      <div style="margin-top:10px; display:flex; gap:8px; align-items:center">
        <button class="btn-ghost" id="playIntroBtn">Play Intro</button>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="summary" role="status" aria-live="polite">
      <div style="font-weight:800;color:#00fc99;margin-bottom:8px">Run Summary</div>
      <div class="stat"><span>Total Devices</span><strong id="totalDevices">0</strong></div>
      <div class="stat"><span>Infected</span><strong id="infectedCount">0</strong></div>
      <div class="stat"><span>Suspected</span><strong id="susCount">0</strong></div>
      <div class="stat"><span>Elapsed</span><strong id="elapsed">0s</strong></div>
    </div>

    <div style="height:12px"></div>

    <div style="font-weight:800;color:#00fc99;margin-bottom:6px">Live Log</div>
    <div class="terminal" id="terminal" role="log" aria-live="polite"></div>
  </div>

  <div class="footer">Developed by Dwij Rajyaguru ¬© 2025 ‚Äî Educational Simulator (No real network access)</div>
</div>

<!-- Device detail modal -->
<div id="deviceModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:999">
  <div style="width:92%;max-width:520px;background:#17213c;border-radius:10px;padding:16px;border:1px solid rgba(0,252,153,0.06);color:#c0fff2">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:800;color:#00fc99" id="modalTitle">Device</div>
      <button onclick="closeDeviceModal()" style="background:#ff3b3b;border:none;color:white;padding:8px 10px;border-radius:8px">Close</button>
    </div>
    <div id="modalBody" style="font-family:monospace;white-space:pre-wrap"></div>
  </div>
</div>

<script>
/* ==========================
  Threat Shield Simulator
  - Single-file educational simulation
  - Safe: visualization only (no network/system access)
  ========================= */

/* ---------- Canvas setup ---------- */
const canvas = document.getElementById('networkCanvas');
let ctx = null;
if (canvas) {
  ctx = canvas.getContext && canvas.getContext('2d');
} else {
  console.warn('networkCanvas element not found');
}

function resizeCanvas(){
  if(!canvas || !ctx) return;
  const ratio = window.devicePixelRatio || 1;
  const w = Math.max(1, Math.floor(canvas.clientWidth * ratio));
  const h = Math.max(1, Math.floor(canvas.clientHeight * ratio));
  canvas.width = w; canvas.height = h;
  ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
  renderNetwork();
}
window.addEventListener('resize', resizeCanvas);
window.addEventListener('load', resizeCanvas);
setTimeout(resizeCanvas, 20);

/* ---------- State ---------- */
let nodes = [];
let links = [];
let logLines = [];
let running = false, paused = false;
let startTime = 0, elapsed = 0;
let tickHandle = null;

/* ---------- UI refs ---------- */
const threatSelect = document.getElementById('threatSelect');
const sizeRange = document.getElementById('sizeRange');
const sizeVal = document.getElementById('sizeVal');
const speedRange = document.getElementById('speedRange');
const speedVal = document.getElementById('speedVal');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const seedBtn = document.getElementById('seedBtn');
const resetBtn = document.getElementById('resetBtn');
const terminal = document.getElementById('terminal');
const totalDevicesEl = document.getElementById('totalDevices');
const infectedCountEl = document.getElementById('infectedCount');
const susCountEl = document.getElementById('susCount');
const elapsedEl = document.getElementById('elapsed');
const exportLogBtn = document.getElementById('exportLog');
const downloadPNGBtn = document.getElementById('downloadPNG');
const volRange = document.getElementById('volRange');

sizeVal.textContent = sizeRange.value;
speedVal.textContent = speedRange.value;

/* ---------- Audio context ---------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
const masterGain = audioCtx.createGain(); masterGain.gain.value = 0.6; masterGain.connect(audioCtx.destination);
volRange.addEventListener('input', ()=> masterGain.gain.value = parseFloat(volRange.value));

function playTone(freq, dur=0.08, type='sawtooth', gain=0.08){
  try{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(masterGain);
    o.start(); o.stop(audioCtx.currentTime + dur);
  }catch(e){}
}
function playAlert(){
  playTone(1400,0.08,'sawtooth',0.08);
  setTimeout(()=>playTone(1000,0.12,'sawtooth',0.09),90);
  setTimeout(()=>playTone(700,0.18,'sawtooth',0.12),220);
}
function playScanPulse(){
  playTone(520,0.06,'sine',0.03);
}

/* ---------- Intro melody ---------- */
function playIntro(){
  if(!audioCtx) return;
  if(audioCtx.state === 'suspended') audioCtx.resume();
  const notes = [880, 1100, 1320, 1760];
  notes.forEach((n, i)=> setTimeout(()=> playTone(n, 0.12, 'triangle', 0.06), i * 160));
  setTimeout(()=> playTone(660, 0.22, 'sine', 0.05), notes.length * 160 + 120);
}

/* ---------- Utilities ---------- */
function nowTS(){ return new Date().toLocaleTimeString(); }
function genIP(){
  return `${Math.floor(10+Math.random()*220)}.${Math.floor(1+Math.random()*220)}.${Math.floor(1+Math.random()*220)}.${Math.floor(1+Math.random()*220)}`;
}
function pickDeviceType(){
  const r = Math.random();
  if(r < 0.45) return 'PC';
  if(r < 0.8) return 'Laptop';
  return 'Phone';
}
function clearLogsUI(){ terminal.innerHTML = ''; logLines = []; }

/* ---------- Build network ---------- */
function buildNetwork(size){
  nodes = []; links = [];
  const w = canvas.clientWidth, h = canvas.clientHeight;
  const cx = w/2, cy = h/2;
  const r = Math.min(w,h)/2 - 80;
  for(let i=0;i<size;i++){
    const angle = (i/size) * Math.PI*2;
    const jitter = (Math.random()-0.5) * 40;
    const x = cx + Math.cos(angle)*(r + jitter);
    const y = cy + Math.sin(angle)*(r + jitter);
    nodes.push({
      id: `ID-${1000 + i}`,
      deviceType: pickDeviceType(),
      x, y,
      state: 'safe',
      ip: genIP(),
      scanning: false,
      lastActionTime: 0
    });
  }
  for(let i=0;i<size;i++){
    const degree = 2 + Math.floor(Math.random()*3);
    for(let k=0;k<degree;k++){
      const other = (i + 1 + Math.floor(Math.random()*(size-1))) % size;
      addLink(i, other);
    }
  }
  for(let i=0;i<Math.floor(size/5);i++){
    const a = Math.floor(Math.random()*size), b = Math.floor(Math.random()*size);
    if(a!==b) addLink(a,b);
  }
  nodes.forEach((n, idx) => {
    n.peers = links.reduce((acc,e,i) => {
      if(e[0]===idx) acc.push(e[1]);
      if(e[1]===idx) acc.push(e[0]);
      return acc;
    }, []);
  });
  pushLog('SYSTEM', `Network built: ${size} devices, ${links.length} links`);
  renderNetwork();
  updateSummary();
}

function addLink(a,b){
  if(a===b) return;
  const exists = links.some(e => (e[0]===a && e[1]===b) || (e[0]===b && e[1]===a));
  if(!exists) links.push([a,b]);
}

/* ---------- Render network ---------- */
function renderNetwork(){
  if(!canvas || !ctx) return;
  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
  ctx.lineWidth = 1;
  links.forEach(([a,b])=>{
    const A = nodes[a], B = nodes[b];
    ctx.beginPath();
    ctx.moveTo(A.x, A.y);
    ctx.lineTo(B.x, B.y);
    ctx.strokeStyle = 'rgba(0,252,153,0.06)';
    ctx.stroke();
  });
  nodes.forEach((n, idx) => {
    if(n.state === 'infected'){
      ctx.shadowColor = 'rgba(255,59,48,0.6)'; ctx.shadowBlur = 18;
    } else if(n.state === 'sus'){
      ctx.shadowColor = 'rgba(242,201,76,0.45)'; ctx.shadowBlur = 10;
    } else {
      ctx.shadowColor = 'rgba(34,197,94,0.25)'; ctx.shadowBlur = 6;
    }
    ctx.beginPath();
    const r = 18;
    ctx.arc(n.x, n.y, r, 0, Math.PI*2);
    if(n.state === 'infected') ctx.fillStyle = 'rgba(255,59,48,1)';
    else if(n.state === 'sus') ctx.fillStyle = 'rgba(242,201,76,0.95)';
    else ctx.fillStyle = 'rgba(34,197,94,0.95)';
    ctx.fill();
    ctx.shadowBlur = 0;
    ctx.font = '18px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    let emoji = 'üíª';
    if(n.deviceType === 'Laptop') emoji = 'üñ•Ô∏è';
    if(n.deviceType === 'Phone') emoji = 'üì±';
    ctx.fillStyle = '#0b0b0b';
    ctx.beginPath(); ctx.arc(n.x, n.y, 8, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#c0fff2';
    ctx.fillText(emoji, n.x, n.y+1);
    ctx.font = '11px Fira Mono';
    ctx.fillStyle = '#c0fff2';
    ctx.fillText(n.id.split('-')[1], n.x, n.y + 30);
    if(n.scanning){
      const t = (Date.now() - n.lastActionTime) / 600;
      const alpha = Math.max(0, 1 - t);
      ctx.beginPath();
      ctx.arc(n.x, n.y, r + 8 + (t*15), 0, Math.PI*2);
      ctx.strokeStyle = `rgba(255,120,120,${alpha*0.55})`;
      ctx.lineWidth = 2;
      ctx.stroke();
    }
  });
}

/* ---------- Logging ---------- */
function pushLog(kind, text, nodeIdx=null){
  const time = new Date().toLocaleTimeString();
  const id = nodeIdx !== null ? nodes[nodeIdx].id : '';
  const ip = nodeIdx !== null ? nodes[nodeIdx].ip : '';
  const entry = {time, id, ip, type: kind, status: text};
  logLines.unshift(entry);
  const el = document.createElement('div');
  el.className = 'term-line';
  el.innerHTML = `<span class="term-time">[${time}]</span><strong style="color:#ff9f9f">${kind}</strong> ‚Äî ${escapeHtml(text)} ${ nodeIdx !== null ? `<span style="color:#c0fff2">(${id} @ ${ip})</span>` : '' }`;
  terminal.prepend(el);
  if(logLines.length > 1500) { logLines.pop(); if(terminal.children.length > 1500) terminal.removeChild(terminal.lastChild); }
}
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------- Simulation logic ---------- */
const trojanDormancy = new Map();

function tickWorm(){
  const infectedIdx = nodes.map((n,i)=> n.state==='infected' ? i : -1).filter(i=>i>=0);
  infectedIdx.forEach(idx => {
    const node = nodes[idx];
    node.peers.forEach(peerIdx => {
      const peer = nodes[peerIdx];
      if(peer.state === 'safe' && Math.random() < 0.68){
        infect(peerIdx, 'Worm spread');
      } else if(peer.state === 'safe' && Math.random() < 0.22){
        markSus(peerIdx, 'Worm heuristic flagged');
      }
    });
  });
}

function tickTrojan(){
  nodes.forEach((n, idx) => {
    if(n.state === 'infected'){
      if(!trojanDormancy.has(idx)) trojanDormancy.set(idx, 2 + Math.floor(Math.random()*4));
      let d = trojanDormancy.get(idx);
      d--;
      if(d <= 0){
        const peers = n.peers;
        if(peers.length){
          const target = peers[Math.floor(Math.random()*peers.length)];
          if(nodes[target].state === 'safe' && Math.random() < 0.36){
            infect(target, 'Trojan activated and infected');
          } else if(nodes[target].state === 'safe' && Math.random() < 0.36){
            markSus(target, 'Trojan triggered suspicious behavior');
          }
        }
        trojanDormancy.set(idx, 9999);
      } else {
        trojanDormancy.set(idx, d);
      }
    }
  });
}

function tickVirus(){
  const attempts = 1 + Math.floor(Math.random()*2);
  for(let i=0;i<attempts;i++){
    const a = Math.floor(Math.random()*nodes.length);
    const peers = nodes[a].peers;
    if(peers.length === 0) continue;
    const b = peers[Math.floor(Math.random()*peers.length)];
    pushLog('VIRUS', `File share simulated between devices ${nodes[a].id} and ${nodes[b].id}`, a);
    if((nodes[a].state==='infected' || nodes[b].state==='infected') && Math.random() < 0.5){
      const from = (nodes[a].state === 'infected') ? a : b;
      const to = (from === a) ? b : a;
      if(nodes[to].state === 'safe'){
        infect(to, `Virus spread via file sharing from ${nodes[from].id}`);
      }
    } else {
      if(Math.random() < 0.12){
        markSus(a, 'Heuristic flagged during sharing');
        markSus(b, 'Heuristic flagged during sharing');
      }
    }
  }
}

function infect(idx, reason){
  const n = nodes[idx];
  if(n.state === 'infected') return;
  n.state = 'infected';
  n.scanning = true;
  n.lastActionTime = Date.now();
  pushLog('INFECT', `${reason}`, idx);
  playAlert();
  setTimeout(()=>{ n.scanning = false; renderNetwork(); }, 900 + Math.random()*800);
  renderNetwork(); updateSummary();
}
function markSus(idx, reason){
  const n = nodes[idx];
  if(n.state !== 'safe') return;
  n.state = 'sus';
  n.scanning = true;
  n.lastActionTime = Date.now();
  pushLog('SUS', `${reason}`, idx);
  playScanPulse();
  setTimeout(()=> { n.scanning = false; renderNetwork(); }, 700 + Math.random()*600);
  renderNetwork(); updateSummary();
}

function seedRandom(){
  if(nodes.length === 0) return;
  const idx = Math.floor(Math.random()*nodes.length);
  infect(idx, 'Seeded initial infection (manual seed)');
}
function seedIndex(idx){
  if(nodes[idx]) infect(idx, 'Seeded initial infection (programmatic)');
}

function startSimulation(){
  if(running) return;
  if(audioCtx.state === 'suspended') audioCtx.resume();
  running = true; paused = false;
  startTime = Date.now(); elapsed = 0;
  if(nodes.filter(n=>n.state==='infected').length === 0) seedRandom();
  pushLog('SYSTEM', `Simulation started (${threatSelect.value.toUpperCase()})`);
  startBtn.disabled = true; pauseBtn.disabled = false; resumeBtn.disabled = true; seedBtn.disabled = true;
  runTicks();
}
function pauseSimulation(){
  if(!running || paused) return;
  paused = true;
  clearInterval(tickHandle);
  elapsed += Date.now() - startTime;
  pushLog('SYSTEM', 'Simulation paused');
  pauseBtn.disabled = true; resumeBtn.disabled = false;
}
function resumeSimulation(){
  if(!running || !paused) return;
  paused = false;
  startTime = Date.now();
  pushLog('SYSTEM', 'Simulation resumed');
  resumeBtn.disabled = true; pauseBtn.disabled = false;
  runTicks();
}
function resetSimulation(){
  clearInterval(tickHandle);
  running = false; paused = false; elapsed = 0;
  nodes.forEach(n => { n.state='safe'; n.scanning=false; });
  logLines = []; terminal.innerHTML = '';
  pushLog('SYSTEM', 'Simulation reset');
  startBtn.disabled = false; pauseBtn.disabled = true; resumeBtn.disabled = true; seedBtn.disabled = false;
  renderNetwork(); updateSummary();
}

function runTicks(){
  const speed = parseInt(speedRange.value);
  const intervalMs = Math.max(180, 1000 - (speed * 80));
  tickHandle = setInterval(()=> {
    if(paused) return;
    const type = threatSelect.value;
    if(type === 'worm') tickWorm();
    else if(type === 'trojan') tickTrojan();
    else if(type === 'virus') tickVirus();
    renderNetwork();
    updateSummary();
  }, intervalMs);
}

/* ---------- UI wiring ---------- */
sizeRange.addEventListener('input', ()=> { sizeVal.textContent = sizeRange.value; buildNetwork(parseInt(sizeRange.value)); });
speedRange.addEventListener('input', ()=> { speedVal.textContent = speedRange.value; });

startBtn.addEventListener('click', ()=> startSimulation());
pauseBtn.addEventListener('click', ()=> pauseSimulation());
resumeBtn.addEventListener('click', ()=> resumeSimulation());
resetBtn.addEventListener('click', ()=> resetSimulation());
seedBtn.addEventListener('click', ()=> { seedRandom(); });

const playIntroBtn = document.getElementById('playIntroBtn');
if(playIntroBtn) playIntroBtn.addEventListener('click', ()=> { if(audioCtx.state === 'suspended') audioCtx.resume(); playIntro(); });

canvas.addEventListener('click', (e)=>{
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  let nearest = -1, nearestDist = 1e9;
  nodes.forEach((n, idx) => {
    const dx = n.x - mouseX, dy = n.y - mouseY;
    const d = Math.sqrt(dx*dx + dy*dy);
    if(d < nearestDist && d < 30){ nearest = idx; nearestDist = d; }
  });
  if(nearest >= 0){
    openDeviceModal(nearest);
  }
});

function openDeviceModal(idx){
  const modal = document.getElementById('deviceModal');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');
  const n = nodes[idx];
  title.textContent = `${n.deviceType} ‚Äî ${n.id}`;
  body.textContent = `ID: ${n.id}\nIP: ${n.ip}\nType: ${n.deviceType}\nState: ${n.state}\nPeers: ${n.peers.length}\n\nActions:\n- Seed this device as infected\n- Mark as safe (restore)\n\nClick 'Seed' to infect now.`;
  modal.style.display = 'flex';
  body.innerHTML += '\n\n';
  const seedBtnEl = document.createElement('button');
  seedBtnEl.textContent = 'Seed';
  seedBtnEl.style.marginTop = '10px';
  seedBtnEl.onclick = ()=>{ infect(idx, 'Seeded via device panel'); closeDeviceModal(); };
  const restoreBtnEl = document.createElement('button');
  restoreBtnEl.textContent = 'Restore';
  restoreBtnEl.style.marginTop = '10px';
  restoreBtnEl.style.marginLeft = '8px';
  restoreBtnEl.onclick = ()=>{ nodes[idx].state='safe'; renderNetwork(); updateSummary(); pushLog('ACTION', `Restored ${nodes[idx].id}`, idx); closeDeviceModal(); };
  body.appendChild(seedBtnEl); body.appendChild(restoreBtnEl);
}
function closeDeviceModal(){ document.getElementById('deviceModal').style.display = 'none'; }

/* ---------- Log / export / screenshot ---------- */
exportLogBtn.addEventListener('click', ()=> {
  if(logLines.length === 0){ pushLog('SYSTEM','No logs to export'); return; }
  const lines = logLines.map(l => `[${l.time}] ${l.type} ‚Äî ${l.status} ${l.id ? `(${l.id} @ ${l.ip})` : ''}`).join('\n');
  const blob = new Blob([lines], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `threatshield-log-${new Date().toISOString().slice(0,19)}.txt`; a.click();
  URL.revokeObjectURL(url);
  pushLog('SYSTEM', 'Exported log file');
});

downloadPNGBtn.addEventListener('click', ()=> {
  const dataUrl = canvas.toDataURL('image/png');
  const a = document.createElement('a'); a.href = dataUrl; a.download = `network-snapshot-${new Date().toISOString().slice(0,19)}.png`; a.click();
  pushLog('SYSTEM', 'Downloaded canvas screenshot');
});

/* ---------- Summary update ---------- */
function updateSummary(){
  totalDevicesEl.textContent = nodes.length;
  infectedCountEl.textContent = nodes.filter(n=>n.state==='infected').length;
  susCountEl.textContent = nodes.filter(n=>n.state==='sus').length;
  const t = running ? Math.floor((Date.now() - startTime + elapsed)/1000) : Math.floor(elapsed/1000);
  elapsedEl.textContent = `${t}s`;
}

/* ---------- init ---------- */
function init(){
  buildNetwork(parseInt(sizeRange.value));
  pushLog('SYSTEM', 'Threat Shield ready. Configure and press Start.');
  setInterval(() => {
    renderNetwork(); updateSummary();
  }, 700);
}
init();

window.addEventListener('keydown', (e) => {
  if(e.code === 'Space'){
    e.preventDefault();
    if(running){
      if(paused) resumeSimulation(); else pauseSimulation();
    }
  }
});
</script>
</body>
</html>
